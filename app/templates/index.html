{% extends "base.html" %}
{% block title %}Chat with Model{% endblock %}
{% block content %}
<div class="container mt-4">
   <h2 class="mb-4">Chat with Doc Assistant Model</h2>
   <div class="mb-4">
      <h5>Query Context Options</h5>
      <div class="form-check">
         <input class="form-check-input" type="radio" name="contextOption" id="contextAll" value="all" checked>
         <label class="form-check-label" for="contextAll">
         Ask in the context of all documents
         </label>
      </div>
      <div class="form-check">
         <input class="form-check-input" type="radio" name="contextOption" id="contextSingle" value="single">
         <label class="form-check-label" for="contextSingle">
         Ask in the context of a single document
         </label>
      </div>
   </div>
   <div class="mb-4">
      <h5>Use Retriever</h5>
      <div class="form-check form-switch">
         <input class="form-check-input" type="checkbox" id="useRetriever" disabled>
         <label class="form-check-label" for="useRetriever">Enable Retriever</label>
      </div>
   </div>
   <div class="card">
      <div class="card-body">
         <div id="chatBox" class="mb-3" style="max-height: 300px; overflow-y: auto;">
         </div>
         <div class="input-group">
            <input type="text" id="userInput" class="form-control" placeholder="Type your question here...">
            <button id="sendButton" class="btn btn-primary">Send</button>
         </div>
      </div>
   </div>
</div>
<script>
   const chatBox = document.getElementById("chatBox");
   const userInput = document.getElementById("userInput");
   const sendButton = document.getElementById("sendButton");
   
   
   function formatTextWithLineBreaks(text) {
       return text.replace(/\n/g, "<br>");
   }
   
   async function sendMessage() {
       const question = userInput.value.trim();
       if (!question) return;
   
   
       chatBox.innerHTML += `<div><strong>You:</strong> ${question}</div>`;
       userInput.value = "";
   
   
       userInput.disabled = true;
       sendButton.disabled = true;
   
   
       const contextOption = document.querySelector('input[name="contextOption"]:checked').value;
       const endpoint = contextOption === "all" ? "/query/query_single/" : "/query/query_split/";
   
       try {
           const response = await fetch(endpoint, {
               method: "POST",
               headers: {
                   "Content-Type": "application/json"
               },
               body: JSON.stringify({ question })
           });
           const data = await response.json();
   
   
           const result = formatTextWithLineBreaks(data.result || "No response available");
           chatBox.innerHTML += `<div><strong>Model:</strong> ${result}</div>`;
           chatBox.scrollTop = chatBox.scrollHeight;
       } catch (error) {
           console.error("Error sending message:", error);
           chatBox.innerHTML += `<div><strong>Error:</strong> Could not retrieve answer.</div>`;
       } finally {
   
           userInput.disabled = false;
           sendButton.disabled = false;
           userInput.focus();
       }
   }
   
   sendButton.addEventListener("click", sendMessage);
   
   userInput.addEventListener("keypress", function (e) {
       if (e.key === "Enter") {
           sendMessage();
       }
   });
</script>
{% endblock %}