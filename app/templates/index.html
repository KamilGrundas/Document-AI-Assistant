{% extends "base.html" %}
{% block title %}Chat with Model{% endblock %}
{% block content %}
<div class="container-fluid d-flex flex-column align-items-center" style="height: 78vh; max-width: 900px">
   <div class="card flex-grow-1 d-flex flex-column w-100" style="max-height: 65vh; overflow-y: auto" id="chatBox">
      <div class="card-body" id="chatContent">
         <!-- Chat messages will be appended here -->
      </div>
   </div>

   <div class="input-group p-3 w-100" style="position: sticky; bottom: 0; background-color: white; z-index: 10">
      <input type="text" id="userInput" class="form-control" placeholder="Type your question here..." />
      <button id="sendButton" class="btn btn-primary">Send</button>
   </div>
</div>

<style>
   .message {
      display: inline-block;
      padding: 10px 15px;
      margin: 5px 0;
      border-radius: 15px;
      max-width: 80%;
      word-wrap: break-word;
   }

   .message-user {
      background-color: #d1e7dd;
      color: #0f5132;
      align-self: flex-end;
   }

   .message-model {
      background-color: #c4dcff;
      color: #202a84;
      align-self: flex-start;
   }
</style>

<script>
   const chatBox = document.getElementById("chatBox");
   const chatContent = document.getElementById("chatContent");
   const userInput = document.getElementById("userInput");
   const sendButton = document.getElementById("sendButton");

   function formatTextWithLineBreaks(text) {
      return text.replace(/\n/g, "<br>");
   }

   async function sendMessage() {
      const question = userInput.value.trim();
      if (!question) return;

      chatContent.innerHTML += `<div class="d-flex justify-content-end"><div class="message message-user"><strong>You:</strong> ${formatTextWithLineBreaks(
         question
      )}</div></div>`;
      userInput.value = "";

      chatBox.scrollTop = chatBox.scrollHeight;

      userInput.disabled = true;
      sendButton.disabled = true;

      const contextOption = document.querySelector(
         'input[name="contextOption"]:checked'
      ).value;
      const endpoint =
         contextOption === "all" ? "/query/query_single/" : "/query/query_split/";

      try {
         const response = await fetch(endpoint, {
            method: "POST",
            headers: {
               "Content-Type": "application/json",
            },
            body: JSON.stringify({ question }),
         });
         const data = await response.json();

         const result = formatTextWithLineBreaks(
            data.result || "No response available"
         );
         chatContent.innerHTML += `<div class="d-flex justify-content-start"><div class="message message-model"><strong>Model:</strong> ${result}</div></div>`;

         chatBox.scrollTop = chatBox.scrollHeight;
      } catch (error) {
         console.error("Error sending message:", error);
         chatContent.innerHTML += `<div class="d-flex justify-content-start"><div class="message message-model"><strong>Error:</strong> Could not retrieve answer.</div></div>`;
         chatBox.scrollTop = chatBox.scrollHeight;
      } finally {
         userInput.disabled = false;
         sendButton.disabled = false;
         userInput.focus();
      }
   }

   sendButton.addEventListener("click", sendMessage);

   userInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
         sendMessage();
      }
   });
</script>

{% endblock %}